<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Duelo de Magos: Ajedrez</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        /* Estilos generales */
        html { overflow-y: auto; } /* Habilitar scroll globalmente */
        body { 
            overscroll-behavior: none; 
            overflow-y: auto; /* Asegurar scroll en el body */
        }
        html.ar-active, body.ar-active { overflow: hidden; width: 100%; height: 100%; margin: 0; padding: 0; }
        .screen { 
            display: none; 
            width: 100%; 
            min-height: 100vh; 
            transition: opacity 0.5s ease-in-out; 
            padding-bottom: 8rem; 
            box-sizing: border-box; /* Asegurar que el padding no cause overflow */
        }
        .screen.active { display: flex; }
        .selection-card, .board-card, .color-swatch, .mode-card { transition: all 0.3s ease; border: 4px solid transparent; }
        .selection-card.selected, .board-card.selected, .color-swatch.selected, .mode-card.selected { border-color: #FBBF24; transform: scale(1.05); }
        #ar-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        .version { position: fixed; bottom: 10px; right: 10px; color: #9ca3af; font-size: 0.8rem; z-index: 100; }
        .game-status { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; z-index: 100; font-size: 1.2rem; display: none; }
        #ar-instructions-ui { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9991; display: flex; justify-content: center; align-items: center; pointer-events: none; background-color: rgba(0,0,0,0.7); color: white; padding: 20px; border-radius: 15px; text-align: center; font-size: 1.2rem; transition: opacity 0.3s; }
        #ar-instructions-ui.hidden { opacity: 0; pointer-events: none; }
        
        /* --- ESTILOS MEJORADOS PARA LA PANTALLA DE CARGA INICIAL --- */
        #initial-loading-screen {
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://image.cdn2.seaart.me/2023-11-11/22394598133357573/9a3b16c0f9915a5843f012fcb837415822d7da03_high.webp');
            background-size: cover;
            background-position: center;
            overflow: hidden; 
            filter: brightness(0.8) contrast(1.2); /* Ajuste de brillo y contraste para el nuevo fondo */
        }
        #loading-content { z-index: 2; filter: none; } /* Asegurar que el contenido no herede el filtro */
        #piece-loader { position: relative; width: 90px; height: 90px; }
        #piece-loader svg { width: 100%; height: 100%; fill: #fde047; filter: drop-shadow(0 0 10px #facc15); position: absolute; top: 0; left: 0; opacity: 0; transition: opacity 0.8s ease-in-out, transform 0.8s ease-in-out; transform: scale(0.8); }
        #piece-loader svg.active { opacity: 1; transform: scale(1); }
        .magic-progress-container { width: 100%; background-color: #4a2a15; border-radius: 20px; border: 3px solid #6b4629; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); padding: 4px; }
        .loading-progress-bar { background: linear-gradient(90deg, #facc15 0%, #fde047 100%); box-shadow: 0 0 8px #facc15, 0 0 15px #fde047; border-radius: 12px; position: relative; transition: width 0.4s cubic-bezier(0.65, 0, 0.35, 1); }
        .loading-progress-bar::after { 
            content: ''; 
            position: absolute; right: -8px; top: 50%; 
            transform: translateY(-50%); 
            width: 20px; height: 20px; 
            background: white; border-radius: 50%; 
            opacity: 1; transition: opacity 0.3s;
            animation: pulse-glow 1.5s infinite ease-in-out;
        }
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 10px 4px white, 0 0 20px 8px #fde047; }
            50% { box-shadow: 0 0 15px 7px white, 0 0 30px 12px #fde047; }
            100% { box-shadow: 0 0 10px 4px white, 0 0 20px 8px #fde047; }
        }

        /* Part√≠culas M√°gicas */
        .particle-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .particle { position: absolute; background: #fde047; border-radius: 50%; opacity: 0; animation: rise 10s infinite linear; box-shadow: 0 0 5px #fde047, 0 0 10px #facc15; }
        @keyframes rise { 0% { transform: translateY(0); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; } }
        
        .a-enter-vr-button { 
            position: fixed !important; bottom: 20px !important; left: 50% !important; 
            transform: translateX(-50%) !important; background-color: #10B991 !important; 
            color: white !important; border: none !important; border-radius: 9999px !important; 
            padding: 0.75rem 2.5rem !important; font-weight: bold !important; font-size: 1.125rem !important; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1) !important; 
            z-index: 9999; /* Asegurar que el bot√≥n est√© por encima de todo */
        }

        /* Animaciones para la pantalla de carga AR (efecto "Doctor Strange") - MEJORADO */
        #ar-entry-loading-screen {
            background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://i.pinimg.com/736x/ec/16/eb/ec16ebb634adab20192282b8a43a797d.jpg');
            background-size: cover;
            background-position: center;
            filter: brightness(0.6) sepia(0.3); /* Oscurecer y dar un tono m√≠stico a la imagen de fondo */
            overflow: hidden;
            position: relative;
        }

        #ar-entry-loading-screen .w-full { 
            filter: none; /* Asegurar que los elementos de carga no hereden el filtro */
            position: relative;
            z-index: 10;
        }

        #ar-loading-visual {
            position: relative;
            width: 180px; /* Tama√±o base del portal */
            height: 180px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
        }

        .portal-ring {
            position: absolute;
            border: 5px solid transparent;
            border-radius: 50%;
            filter: drop-shadow(0 0 10px #facc15) drop-shadow(0 0 25px #fde047);
        }

        .portal-ring-1 {
            width: 180px; height: 180px;
            border-top-color: #fde047;
            border-right-color: #facc15;
            animation: portal-spin 8s linear infinite, portal-pulse 2s ease-in-out infinite;
        }

        .portal-ring-2 {
            width: 150px; height: 150px;
            border-bottom-color: #fde047;
            border-left-color: #facc15;
            animation: portal-spin-reverse 10s linear infinite, portal-pulse 2.2s ease-in-out infinite;
            animation-delay: -0.5s;
        }

        .portal-ring-3 {
            width: 120px; height: 120px;
            border-top-color: #facc15;
            border-left-color: #fde047;
            animation: portal-spin 12s linear infinite, portal-pulse 2.5s ease-in-out infinite;
            animation-delay: -1s;
        }
        
        .floating-king-icon {
            position: relative; 
            z-index: 10;
            animation: float-and-rotate 3s ease-in-out infinite, magic-glow 2s infinite alternate;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.7)) drop-shadow(0 0 20px rgba(253, 224, 71, 0.8));
        }

        @keyframes portal-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes portal-spin-reverse {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }

        @keyframes portal-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }

        @keyframes float-and-rotate {
            0% { transform: translateY(0) rotateY(0deg); }
            50% { transform: translateY(-10px) rotateY(10deg); }
            100% { transform: translateY(0) rotateY(0deg); }
        }
        @keyframes magic-glow {
            0% { filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.7)) drop-shadow(0 0 20px rgba(253, 224, 71, 0.8)); }
            50% { filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.9)) drop-shadow(0 0 25px rgba(253, 224, 71, 1)); }
            100% { filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.7)) drop-shadow(0 0 20px rgba(253, 224, 71, 0.8)); }
        }
    </style>
</head>
<body class="bg-stone-900 text-white">
    <div id="app-version" class="version"></div>
    <div id="game-status" class="game-status"></div>

    <!-- Pantallas de UI -->
    <div id="welcome-screen" class="screen active flex-col justify-center items-center text-center p-8 bg-cover bg-center relative overflow-hidden" style="background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://i.pinimg.com/originals/47/42/de/4742de0418e35d8c55a2948cd86ec6fa.jpg');">
        <!-- Texto de fondo decorativo -->
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
            <h2 class="text-8xl md:text-[10rem] lg:text-[12rem] font-black text-white opacity-10 select-none transform -translate-y-4">Ajedrez M√°gico</h2>
        </div>

        <!-- Contenido principal -->
        <div class="relative z-10 flex flex-col items-center">
            <h1 class="text-5xl md:text-7xl font-extrabold mb-4 text-amber-300 drop-shadow-lg">Duelo de Ajedrez M√°gico</h1>
            <p class="text-lg md:text-xl max-w-2xl mb-8 text-stone-200">Invoca un tablero de ajedrez 3D en tu propio entorno.</p>
            <button id="start-btn" class="bg-amber-400 text-stone-900 font-bold py-3 px-8 rounded-full text-lg shadow-lg hover:bg-amber-300 transition-transform transform hover:scale-105">Empezar Duelo</button>
        </div>
    </div>
    
    <div id="initial-loading-screen" class="screen relative flex-col justify-center items-center text-center p-8">
        <div id="particle-container" class="particle-container"></div>
        <div id="loading-content" class="w-full max-w-lg relative z-10">
            <h2 id="loading-title" class="text-4xl font-bold mb-6 text-amber-300 drop-shadow-lg">Preparando el Campo de Batalla</h2>
            <div id="piece-loader" class="mb-6 h-24 mx-auto"></div>
            <p id="loading-text" class="text-center text-stone-300 mt-2 text-lg mb-4">Forjando nuevos artefactos m√°gicos...</p>
            <div class="magic-progress-container">
                <div id="initial-loading-progress-bar" class="loading-progress-bar" style="width: 0%; height: 16px;"></div>
            </div>
        </div>
    </div>

    <div id="selection-screen" class="screen flex-col justify-center items-center p-8 bg-stone-800">
        <div class="text-center mb-10 mt-10"><h2 class="text-4xl font-bold mb-2 text-amber-300">Selecciona tu Ej√©rcito</h2><p class="text-stone-300">Elige el estilo de piezas para tu partida.</p></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl w-full">
            <div class="selection-card bg-stone-700 rounded-lg p-6 text-center cursor-pointer" data-set="harry-potter"><div class="w-full h-48 bg-stone-600 rounded-md mb-4 flex items-center justify-center text-6xl">üßô‚Äç‚ôÇÔ∏è</div><h3 class="text-2xl font-semibold mb-2">Ajedrez M√°gico</h3><p class="text-stone-400">Piezas inspiradas en el mundo de los magos.</p></div>
            <div class="selection-card bg-stone-700 rounded-lg p-6 text-center cursor-pointer" data-set="futuristic"><div class="w-full h-48 bg-stone-600 rounded-md mb-4 flex items-center justify-center"><span class="text-8xl">‚ôú</span></div><h3 class="text-2xl font-semibold mb-2">Vanguardia Futurista</h3><p class="text-stone-400">Dise√±o moderno y disruptivo.</p></div>
        </div>
        <button id="continue-set-btn" class="mt-12 bg-amber-500 text-stone-900 font-bold py-3 px-10 rounded-full text-lg hover:bg-amber-400 transition-all shadow-lg disabled:bg-stone-600 disabled:cursor-not-allowed" disabled>Continuar</button>
    </div>
    
    <div id="board-selection-screen" class="screen flex-col justify-center items-center p-8 bg-stone-800">
        <div class="text-center mb-10 mt-10"><h2 class="text-4xl font-bold mb-2 text-amber-300">Personaliza tu Partida</h2><p class="text-stone-300">Elige tu tablero y el color de tus piezas.</p></div>
        <div class="max-w-4xl w-full">
            <h3 class="text-2xl font-semibold mb-4 text-amber-200">Elige un tablero</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                <div class="board-card bg-stone-700 rounded-lg p-4 text-center cursor-pointer" data-board="classic-wood"><img src="https://placehold.co/400x300/854d0e/fefce8?text=Madera+Cl√°sica" class="w-full h-40 object-cover rounded-md mb-3" alt="Tablero de madera cl√°sica"><p>Madera Cl√°sica</p></div>
                <div class="board-card bg-stone-700 rounded-lg p-4 text-center cursor-pointer" data-board="classic-marble"><img src="https://placehold.co/400x300/d1d5db/1f2937?text=M√°rmol+Elegante" class="w-full h-40 object-cover rounded-md mb-3" alt="Tablero de m√°rmol elegante"><p>M√°rmol Elegante</p></div>
            </div>
            <h3 class="text-2xl font-semibold mb-4 text-amber-200">Elige el color de tus tropas</h3>
            <div class="flex justify-center gap-6"><div class="color-swatch rounded-full w-16 h-16 cursor-pointer bg-white" data-color="w"></div><div class="color-swatch rounded-full w-16 h-16 cursor-pointer bg-gray-800" data-color="b"></div></div>
        </div>
        <button id="continue-board-btn" class="mt-12 bg-amber-500 text-stone-900 font-bold py-3 px-10 rounded-full text-lg hover:bg-amber-400 shadow-lg disabled:bg-stone-600 disabled:cursor-not-allowed" disabled>Continuar</button>
        <button id="back-to-set-btn" class="mt-4 bg-stone-700 text-white font-bold py-2 px-6 rounded-full hover:bg-stone-600">Volver</button>
    </div>

    <div id="game-mode-screen" class="screen flex-col justify-center items-center p-8 bg-stone-800">
        <div class="text-center mb-10 mt-10"><h2 class="text-4xl font-bold mb-2 text-amber-300">Modo de Duelo</h2><p class="text-stone-300">¬øC√≥mo quieres jugar?</p></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl w-full">
            <div class="mode-card bg-stone-700 rounded-lg p-6 text-center cursor-pointer" data-mode="pva"><div class="w-full h-48 bg-stone-600 rounded-md mb-4 flex items-center justify-center text-6xl">ü§ñ</div><h3 class="text-2xl font-semibold">Estratega Solitario (vs. Or√°culo)</h3></div>
            <div class="mode-card bg-stone-700 rounded-lg p-6 text-center cursor-pointer" data-mode="pvp"><div class="w-full h-48 bg-stone-600 rounded-md mb-4 flex items-center justify-center text-6xl">üßë‚Äçü§ù‚Äçüßë</div><h3 class="text-2xl font-semibold">Duelo de Leyendas (1 vs. 1)</h3></div>
        </div>
        <button id="start-game-btn" class="mt-12 bg-green-500 text-white font-bold py-3 px-10 rounded-full text-lg hover:bg-green-400 shadow-lg disabled:bg-stone-600 disabled:cursor-not-allowed" disabled>Continuar</button>
        <button id="back-to-board-select-btn" class="mt-4 bg-stone-700 text-white font-bold py-2 px-6 rounded-full hover:bg-stone-600">Volver</button>
    </div>

    <div id="instructions-screen" class="screen flex-col justify-center items-center text-center p-8 bg-stone-800">
        <h2 class="text-4xl font-bold mb-4 text-amber-300">Prepara tu Espacio de Juego</h2>
        <p class="text-stone-300 max-w-xl mb-6">El portal m√°gico necesita detectar una superficie plana y bien iluminada.</p>
        <div class="text-6xl mb-4">üì±</div>
        <p class="text-stone-300 max-w-xl mb-8">Cuando aparezca el bot√≥n para "INVOCAR", presi√≥nalo. Luego mueve tu c√°mara lentamente sobre una mesa o el suelo hasta que veas un ret√≠culo, y toca la pantalla para materializar el tablero.</p>
        <button id="start-ar-btn" class="bg-green-500 text-white font-bold py-3 px-10 rounded-full text-lg hover:bg-green-400 shadow-lg">Entrar al Portal</button>
        <button id="back-to-mode-select-btn" class="mt-4 bg-stone-700 text-white font-bold py-2 px-6 rounded-full hover:bg-stone-600">Volver</button>
    </div>
    
    <div id="ar-entry-loading-screen" class="screen flex-col justify-center items-center text-center p-8">
        <div id="particle-container-ar" class="particle-container"></div>
        <div class="w-full max-w-lg z-10 flex flex-col items-center">
            <h2 id="ar-loading-status-title" class="text-4xl font-bold mb-4 text-amber-300">Abriendo Portal...</h2>
            <div id="ar-loading-visual">
                <div class="portal-ring portal-ring-1"></div>
                <div class="portal-ring portal-ring-2"></div>
                <div class="portal-ring portal-ring-3"></div>
                <div class="floating-king-icon text-8xl text-amber-300">‚ôî</div>
            </div>
            <p id="ar-loading-status-text" class="text-stone-300 max-w-xl mb-6">Alineando el plano astral...</p>
        </div>
    </div>


    <div id="ar-screen" class="screen flex-col justify-center items-center bg-transparent">
        <div id="ar-container">
            <!-- La escena AR ahora vive aqu√≠ permanentemente, pero oculta al inicio -->
            <a-scene id="ar-scene" 
                vr-mode-ui="enabled: false;" 
                webxr="optionalFeatures: hit-test, local-floor, dom-overlay; overlayElement: #ar-ui-overlay;" 
                renderer="colorManagement: true; physicallyCorrectLights: true;"
                ar-logic 
                loading-screen="enabled: false;"
                style="display: none;"> 
                
                <a-assets id="ar-assets" timeout="10000"></a-assets>
                
                <a-camera></a-camera>
                <a-light type="ambient" color="#FFF" intensity="1.2"></a-light>
                <a-light type="directional" position="-1 2 1" intensity="1.0"></a-light>
                <a-entity id="board-container" visible="false"></a-entity>
                <a-entity id="reticle" geometry="primitive: ring; radiusInner: 0.06; radiusOuter: 0.08;" material="color: #FBBF24; shader: flat;" visible="false"></a-entity>
            </a-scene>
        </div>
        <div id="ar-ui-overlay" class="absolute top-0 left-0 w-full h-full pointer-events-none">
            <button id="exit-ar-btn" class="absolute top-5 left-5 bg-stone-700/70 text-white font-bold py-2 px-6 rounded-full hover:bg-stone-600 z-30 pointer-events-auto" style="display: none;">Rendirse</button>
            <div id="ar-instructions-ui" class="hidden">
                <p id="ar-instructions-text">Mueve tu dispositivo para encontrar una superficie.</p>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chess.js@0.12.0/chess.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const APP_VERSION = "3.13.0"; // Versi√≥n con Fondo de Carga y C√°mara Estable
            document.getElementById('app-version').textContent = `v${APP_VERSION}`;

            // --- Estado del juego y variables globales ---
            let game = new Chess();
            let gameState = 'IDLE';
            let selectedPieceEntity = null;
            let legalMoveEntities = [];
            let playerColor = 'w';
            let gameMode = 'pva';
            let selectedSet = null;
            let selectedBoard = null;
            let sceneEl = document.getElementById('ar-scene'); // Obtener la escena A-Frame ya en el DOM
            let boardPlaced = false;
            let loadingPhrasesInterval = null;

            const screens = {
                welcome: document.getElementById('welcome-screen'),
                initialLoading: document.getElementById('initial-loading-screen'),
                selection: document.getElementById('selection-screen'),
                boardSelection: document.getElementById('board-selection-screen'),
                gameMode: document.getElementById('game-mode-screen'),
                instructions: document.getElementById('instructions-screen'),
                arEntryLoading: document.getElementById('ar-entry-loading-screen'),
                ar: document.getElementById('ar-screen'),
            };
            const buttons = {
                start: document.getElementById('start-btn'),
                continueSet: document.getElementById('continue-set-btn'),
                continueBoard: document.getElementById('continue-board-btn'),
                startGame: document.getElementById('start-game-btn'),
                startAR: document.getElementById('start-ar-btn'),
                backToSet: document.getElementById('back-to-set-btn'),
                backToBoardSelect: document.getElementById('back-to-board-select-btn'),
                backToModeSelect: document.getElementById('back-to-mode-select-btn'),
                exitAR: document.getElementById('exit-ar-btn'),
            };

            const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/instructorandradedcc/Ecoajedres-AR/main/';
            const assetMap = {
                'harry-potter': {
                    w: { p: { url: `${GITHUB_BASE_URL}Pawn_Gryffindor.glb`, scale: '0.02 0.02 0.02' }, r: { url: `${GITHUB_BASE_URL}Rook_Dobby.glb`, scale: '0.02 0.02 0.02' }, n: { url: `${GITHUB_BASE_URL}Knight_RWeasley.glb`, scale: '0.02 0.02 0.02' }, b: { url: `${GITHUB_BASE_URL}Bishop_HPotter.glb`, scale: '0.02 0.02 0.02' }, q: { url: `${GITHUB_BASE_URL}Queen_Hermione.glb`, scale: '0.02 0.02 0.02' }, k: { url: `${GITHUB_BASE_URL}King_Dumbledore.glb`, scale: '0.02 0.02 0.02' } },
                    b: { p: { url: `${GITHUB_BASE_URL}Pawn_Sytherin.glb`, scale: '0.02 0.02 0.02' }, r: { url: `${GITHUB_BASE_URL}Rook_Dobby2.glb`, scale: '0.02 0.02 0.02' }, n: { url: `${GITHUB_BASE_URL}Knight_RWeasley.glb`, scale: '0.02 0.02 0.02', rotation: '0 180 0' }, b: { url: `${GITHUB_BASE_URL}Bishop_HPotter_Hollow.glb`, scale: '0.02 0.02 0.02' }, q: { url: `${GITHUB_BASE_URL}Queen_Hermione.glb`, scale: '0.02 0.02 0.02', rotation: '0 180 0' }, k: { url: `${GITHUB_BASE_URL}King_Voldemort.glb`, scale: '0.02 0.02 0.02' } }
                },
                'futuristic': { w: { p: { url: ``, scale: '0.1 0.1 0.1' } }, b: { p: { url: ``, scale: '0.1 0.1 0.1' } } }
            };

            function navigateTo(screenName) {
                // Desactivar AR mode si salimos de la pantalla AR
                if (screenName !== 'ar' && sceneEl && sceneEl.is('ar-mode')) {
                    sceneEl.exitVR();
                }

                Object.values(screens).forEach(s => s.classList.remove('active'));
                screens[screenName].classList.add('active');

                // Ajustar overflow del HTML/BODY para AR o UI normal
                if (screenName === 'ar' || screenName === 'arEntryLoading') {
                    document.documentElement.classList.add('ar-active');
                    document.body.classList.add('ar-active');
                } else {
                    document.documentElement.classList.remove('ar-active');
                    document.body.classList.remove('ar-active');
                }
                
                // Mostrar la escena AR solo cuando sea necesario
                if (screenName === 'ar') {
                    sceneEl.style.display = 'block'; 
                } else {
                    sceneEl.style.display = 'none'; 
                }
            }
            
            function createParticles(containerId, count = 25) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = ''; 
                for (let i = 0; i < count; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    p.style.left = `${Math.random() * 100}%`;
                    p.style.top = `${Math.random() * 100}%`;
                    const size = Math.random() * 8 + 2;
                    p.style.width = `${size}px`; p.style.height = `${size}px`;
                    p.style.animationDelay = `${Math.random() * 10}s`;
                    container.appendChild(p);
                }
            }
            
            function preloadAllAssets() {
                navigateTo('initialLoading');
                initializeLoadingScreenVisuals();
                createParticles('particle-container');
                const progressBar = document.getElementById('initial-loading-progress-bar');
                const loadingText = document.getElementById('loading-text');

                if (localStorage.getItem('assets_preloaded_v1')) {
                    loadingText.textContent = "Verificando artefactos en el castillo...";
                } else {
                    loadingText.textContent = "Forjando nuevos artefactos m√°gicos...";
                }

                const tempScene = document.createElement('a-scene');
                tempScene.style.cssText = 'position: absolute; height: 1px; width: 1px; left: -9999px; top: -9999px;';
                const assetsEl = document.createElement('a-assets');
                assetsEl.setAttribute('timeout', '60000');

                const allAssetUrls = new Set();
                Object.values(assetMap).forEach(pieceSet => {
                    Object.values(pieceSet.w).forEach(p => p.url && allAssetUrls.add(p.url));
                    Object.values(pieceSet.b).forEach(p => p.url && allAssetUrls.add(p.url));
                });
                
                if (allAssetUrls.size === 0) {
                    loadingText.textContent = "¬°Arsenal listo! No hay artefactos que forjar.";
                    setTimeout(() => navigateTo('selection'), 1000); return;
                }

                let assetsContent = Array.from(allAssetUrls).map(url => `<a-asset-item id="preload-${url}" src="${url}"></a-asset-item>`).join('');
                assetsEl.innerHTML = assetsContent;
                tempScene.appendChild(assetsEl);
                document.body.appendChild(tempScene);

                assetsEl.addEventListener('progress', (event) => {
                    const progress = event.detail.progress * 100;
                    if (!isNaN(progress)) {
                        progressBar.style.width = `${progress}%`;
                        if (!localStorage.getItem('assets_preloaded_v1')) {
                             loadingText.textContent = `Forjando nuevos artefactos m√°gicos... (${Math.round(progress)}%)`;
                        }
                    }
                });

                assetsEl.addEventListener('loaded', () => {
                    loadingText.textContent = "¬°Arsenal m√°gico listo!";
                    localStorage.setItem('assets_preloaded_v1', 'true'); 
                    setTimeout(() => {
                        document.body.removeChild(tempScene);
                        navigateTo('selection');
                    }, 500);
                });

                assetsEl.addEventListener('timeout', () => {
                    loadingText.textContent = "Error: La forja m√°gica fall√≥. Revisa tu conexi√≥n.";
                });
            }

            buttons.start.addEventListener('click', () => { preloadAllAssets(); });
            document.querySelectorAll('.selection-card').forEach(card => card.addEventListener('click', e => {
                document.querySelectorAll('.selection-card').forEach(c => c.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                selectedSet = e.currentTarget.dataset.set;
                buttons.continueSet.disabled = false;
            }));
            buttons.continueSet.addEventListener('click', () => navigateTo('boardSelection'));
            document.querySelectorAll('.board-card').forEach(card => card.addEventListener('click', e => {
                document.querySelectorAll('.board-card').forEach(c => c.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                selectedBoard = e.currentTarget.dataset.board;
                if (playerColor) buttons.continueBoard.disabled = false;
            }));
            document.querySelectorAll('.color-swatch').forEach(swatch => swatch.addEventListener('click', e => {
                document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                playerColor = e.currentTarget.dataset.color;
                if (selectedBoard) buttons.continueBoard.disabled = false;
            }));
            buttons.continueBoard.addEventListener('click', () => navigateTo('gameMode'));
            document.querySelectorAll('.mode-card').forEach(card => card.addEventListener('click', e => {
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                gameMode = e.currentTarget.dataset.mode;
                buttons.startGame.disabled = false;
            }));
            buttons.startGame.addEventListener('click', () => navigateTo('instructions'));
            buttons.backToSet.addEventListener('click', () => navigateTo('selection'));
            buttons.backToBoardSelect.addEventListener('click', () => navigateTo('boardSelection'));
            buttons.backToModeSelect.addEventListener('click', () => navigateTo('gameMode'));
            buttons.exitAR.addEventListener('click', () => {
                clearInterval(loadingPhrasesInterval);
                if (sceneEl && sceneEl.is('ar-mode')) {
                    sceneEl.exitVR();
                }
                navigateTo('gameMode');
            });
            
            buttons.startAR.addEventListener('click', () => { setupARScene(); });

            function setupARScene() {
                navigateTo('arEntryLoading');
                createParticles('particle-container-ar');
                
                const arLoadingText = document.getElementById('ar-loading-status-text');
                const phrases = [ "Alineando el plano astral...", "Invocando poder arcano...", "Estabilizando la conexi√≥n...", "Enfocando la lente m√°gica...", "Casi listo para el duelo..." ];
                let phraseIndex = 0;
                arLoadingText.textContent = phrases[phraseIndex];
                loadingPhrasesInterval = setInterval(() => {
                    phraseIndex = (phraseIndex + 1) % phrases.length;
                    arLoadingText.textContent = phrases[phraseIndex];
                }, 2500);

                const assetsEl = document.getElementById('ar-assets');
                assetsEl.innerHTML = ''; // Limpiar assets previos
                const assetUrls = new Set();
                if (assetMap[selectedSet]) {
                    Object.values(assetMap[selectedSet].w).forEach(p => p.url && assetUrls.add(p.url));
                    Object.values(assetMap[selectedSet].b).forEach(p => p.url && assetUrls.add(p.url));
                }
                
                let assetsContent = Array.from(assetUrls).map(url => `<a-asset-item id="${url}" src="${url}"></a-asset-item>`).join('');
                assetsEl.innerHTML = assetsContent;

                
                if (sceneEl.hasLoaded) {
                    clearInterval(loadingPhrasesInterval);
                    navigateTo('ar');
                    sceneEl.setAttribute('vr-mode-ui', 'enabled', true);
                    sceneEl.setAttribute('vr-mode-ui', 'enterARButtonText', 'INVOCAR TABLERO');
                } else {
                     sceneEl.addEventListener('loaded', () => {
                        clearInterval(loadingPhrasesInterval);
                        navigateTo('ar');
                        sceneEl.setAttribute('vr-mode-ui', 'enabled', true);
                        sceneEl.setAttribute('vr-mode-ui', 'enterARButtonText', 'INVOCAR TABLERO');
                    }, { once: true });
                }
            }
            
            AFRAME.registerComponent('ar-logic', {
                 init: function() {
                    this.reticle = document.querySelector('#reticle');
                    this.boardContainer = document.querySelector('#board-container');
                    this.hitTestSource = null;
                    
                    this.touchState = {
                        dragging: false, pinching: false, startDist: 0, startAngle: 0,
                        initialScale: new THREE.Vector3(), initialRotation: new THREE.Euler(),
                        lastTouch: { x: 0, y: 0 }
                    };

                    this.onEnterVR = this.onEnterVR.bind(this);
                    this.onExitVR = this.onExitVR.bind(this);
                    this.onSelect = this.onSelect.bind(this);
                    this.onTouchStart = this.onTouchStart.bind(this);
                    this.onTouchMove = this.onTouchMove.bind(this);
                    this.onTouchEnd = this.onTouchEnd.bind(this);
                    
                    this.el.sceneEl.addEventListener('enter-vr', this.onEnterVR);
                    this.el.sceneEl.addEventListener('exit-vr', this.onExitVR);
                    this.el.sceneEl.addEventListener('click', this.handleGameClick.bind(this));
                },
                tick: function() {
                    if (!this.el.sceneEl.is('ar-mode') || !this.hitTestSource || boardPlaced) return;
                    const frame = this.el.sceneEl.renderer.xr.getFrame();
                    if (!frame) return;
                    const hitTestResults = frame.getHitTestResults(this.hitTestSource);
                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        const referenceSpace = this.el.sceneEl.renderer.xr.getReferenceSpace();
                        const pose = hit.getPose(referenceSpace);
                        this.reticle.setAttribute('visible', 'true');
                        this.reticle.object3D.position.copy(pose.transform.position);
                        this.reticle.object3D.quaternion.copy(pose.transform.quaternion);
                    } else {
                        this.reticle.setAttribute('visible', 'false');
                    }
                },
                onEnterVR: async function() {
                    if (this.el.sceneEl.is('ar-mode')) {
                        const canvas = this.el.sceneEl.canvas;
                        canvas.addEventListener('touchstart', this.onTouchStart);
                        canvas.addEventListener('touchmove', this.onTouchMove);
                        canvas.addEventListener('touchend', this.onTouchEnd);
                        
                        document.getElementById('ar-instructions-ui').classList.remove('hidden');
                        buttons.exitAR.style.display = 'block';
                        boardPlaced = false; game.reset();
                        this.boardContainer.setAttribute('visible', 'false');
                        this.boardContainer.innerHTML = '';
                        try {
                            const session = this.el.sceneEl.renderer.xr.getSession();
                            session.addEventListener('select', this.onSelect); 
                            const viewerReferenceSpace = await session.requestReferenceSpace('viewer');
                            this.hitTestSource = await session.requestHitTestSource({ space: viewerReferenceSpace });
                        } catch (e) { this.hitTestSource = null; }
                    }
                },
                onExitVR: function() {
                    const canvas = this.el.sceneEl.canvas;
                    canvas.removeEventListener('touchstart', this.onTouchStart);
                    canvas.removeEventListener('touchmove', this.onTouchMove);
                    canvas.removeEventListener('touchend', this.onTouchEnd);

                    if (this.hitTestSource) this.hitTestSource = null;
                    const session = this.el.sceneEl.renderer.xr.getSession();
                    if(session) session.removeEventListener('select', this.onSelect);
                    navigateTo('gameMode');
                },
                onSelect: function() {
                    if (!boardPlaced && this.reticle.getAttribute('visible')) {
                        this.boardContainer.setAttribute('position', this.reticle.object3D.position);
                        this.boardContainer.setAttribute('visible', 'true');
                        this.reticle.setAttribute('visible', 'false');
                        boardPlaced = true;
                        document.getElementById('ar-instructions-ui').classList.add('hidden');
                        document.getElementById('game-status').style.display = 'block';
                        create3DBoard(this.boardContainer);
                        renderBoardFromFen(this.boardContainer);
                        updateGameStatus();
                        this.hitTestSource = null; 
                    }
                },
                handleGameClick: function(evt) { if (boardPlaced && !this.touchState.dragging && !this.touchState.pinching) handleGameClick(evt); },
                
                onTouchStart: function(e) {
                    if (!boardPlaced || e.touches.length > 2) return;
                    e.preventDefault();

                    if (e.touches.length === 1) {
                        this.touchState.dragging = true;
                        this.touchState.lastTouch.x = e.touches[0].clientX;
                        this.touchState.lastTouch.y = e.touches[0].clientY;
                    } else if (e.touches.length === 2) {
                        this.touchState.dragging = false; this.touchState.pinching = true;
                        this.touchState.initialScale.copy(this.boardContainer.object3D.scale);
                        this.touchState.initialRotation.copy(this.boardContainer.object3D.rotation);
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        this.touchState.startDist = Math.sqrt(dx * dx + dy * dy);
                        this.touchState.startAngle = Math.atan2(dy, dx);
                    }
                },
                onTouchMove: function(e) {
                    if (!boardPlaced) return;
                    e.preventDefault();

                    if (this.touchState.dragging && e.touches.length === 1) {
                        const deltaX = e.touches[0].clientX - this.touchState.lastTouch.x;
                        const deltaY = e.touches[0].clientY - this.touchState.lastTouch.y;
                        const boardPos = this.boardContainer.object3D.position;
                        const camera = this.el.sceneEl.camera;
                        const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
                        const right = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion);
                        boardPos.add(right.multiplyScalar(deltaX * 0.001));
                        boardPos.add(forward.multiplyScalar(deltaY * 0.001));

                        this.touchState.lastTouch.x = e.touches[0].clientX;
                        this.touchState.lastTouch.y = e.touches[0].clientY;
                    } else if (this.touchState.pinching && e.touches.length === 2) {
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        const currentDist = Math.sqrt(dx * dx + dy * dy);
                        const scaleFactor = currentDist / this.touchState.startDist;
                        this.boardContainer.object3D.scale.copy(this.touchState.initialScale).multiplyScalar(scaleFactor);

                        const currentAngle = Math.atan2(dy, dx);
                        const angleDelta = currentAngle - this.touchState.startAngle;
                        this.boardContainer.object3D.rotation.y = this.touchState.initialRotation.y + angleDelta;
                    }
                },
                onTouchEnd: function(e) {
                    if (e.touches.length < 2) this.touchState.pinching = false;
                    if (e.touches.length < 1) this.touchState.dragging = false;
                }
            });

            // --- L√≥gica de juego y UI ---
            function initializeLoadingScreenVisuals() {
                const pieceLoader = document.getElementById('piece-loader');
                pieceLoader.innerHTML = '';
                const pieces = [
                    `<svg data-piece="king" viewBox="0 0 45 45"><path d="M22.5 11.63V6M20 8h5M22.5 25s4.5-7.5 3-10.5c0 0-1.5-3-3-3s-3 3-3 3c-1.5 3 3 10.5 3 10.5" stroke="#FFF" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none"></path><path d="M12.5 37h20v-2.5h-20V37zM12.5 32.5h20v-2.5h-20v2.5zM12.5 27.5h20v-2.5h-20v2.5z" stroke="#FFF" stroke-width="1.5" fill="#FFF"></path></svg>`,
                    `<svg data-piece="queen" viewBox="0 0 45 45"><path d="M9 13.5s1 4.5 3.5 4.5 3.5-4.5 3.5-4.5 1-4.5 3.5-4.5 3.5 4.5 3.5 4.5 1 4.5 3.5 4.5 3.5-4.5 3.5-4.5 1-4.5 3.5-4.5" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none" stroke="#FFF"></path><path d="M12.5 37h20v-2.5h-20V37zM12.5 32.5h20v-2.5h-20v2.5zM12.5 27.5h20v-2.5h-20v2.5z" stroke="#FFF" stroke-width="1.5" fill="#FFF"></path><circle cx="6" cy="12" r="1.2" fill="#FFF"></circle><circle cx="12.5" cy="9.5" r="1.2" fill="#FFF"></circle><circle cx="19.5" cy="9.5" r="1.2" fill="#FFF"></circle><circle cx="26.5" cy="9.5" r="1.2" fill="#FFF"></circle><circle cx="33" cy="9.5" r="1.2" fill="#FFF"></circle><circle cx="39" cy="12" r="1.2" fill="#FFF"></circle></svg>`,
                ];
                pieceLoader.innerHTML = pieces.join('');
                let currentPiece = 0;
                const pieceElements = pieceLoader.querySelectorAll('svg');
                pieceElements[currentPiece].classList.add('active');
                setInterval(() => {
                    pieceElements[currentPiece].classList.remove('active');
                    currentPiece = (currentPiece + 1) % pieceElements.length;
                    pieceElements[currentPiece].classList.add('active');
                }, 2000);
            }
            function create3DBoard(parent) {
                const boardSize = 0.6; const squareSize = boardSize / 8;
                const boardGroup = document.createElement('a-entity');
                boardGroup.setAttribute('id', 'board-group');
                const boardBase = document.createElement('a-box');
                boardBase.setAttribute('width', boardSize + 0.04); boardBase.setAttribute('height', 0.02);
                boardBase.setAttribute('depth', boardSize + 0.04); boardBase.setAttribute('color', '#4a2a15');
                boardBase.setAttribute('position', '0 -0.01 0');
                boardGroup.appendChild(boardBase);
                for(let i = 0; i < 8; i++) {
                    for(let j = 0; j < 8; j++) {
                        const squareEl = document.createElement('a-plane');
                        squareEl.setAttribute('width', squareSize); squareEl.setAttribute('height', squareSize);
                        squareEl.setAttribute('color', (i + j) % 2 === 0 ? '#D18B47' : '#FFCE9E');
                        const x = -boardSize/2 + squareSize/2 + j * squareSize;
                        const z = -boardSize/2 + squareSize/2 + i * squareSize;
                        squareEl.setAttribute('position', `${x} 0.001 ${z}`);
                        squareEl.setAttribute('rotation', '-90 0 0');
                        squareEl.dataset.square = 'abcdefgh'[j] + (8 - i);
                        squareEl.classList.add('clickable-square');
                        boardGroup.appendChild(squareEl);
                    }
                }
                parent.appendChild(boardGroup);
            }
            function renderBoardFromFen(parent) {
                const boardGroup = parent.querySelector('#board-group') || parent;
                boardGroup.querySelectorAll('.chess-piece').forEach(el => el.remove());
                const boardSize = 0.6; const squareSize = boardSize / 8;
                const offset = -boardSize/2 + squareSize/2;
                game.board().forEach((row, i) => {
                    row.forEach((piece, j) => {
                        if (!piece) return;
                        const pieceEl = document.createElement('a-entity');
                        pieceEl.classList.add('chess-piece');
                        pieceEl.dataset.square = piece.square;
                        if (assetMap[selectedSet]?.[piece.color]?.[piece.type]?.url) {
                            const modelData = assetMap[selectedSet][piece.color][piece.type];
                            pieceEl.setAttribute('gltf-model', `#${modelData.url}`);
                            pieceEl.setAttribute('scale', modelData.scale);
                            if(modelData.rotation) pieceEl.setAttribute('rotation', modelData.rotation);
                        }
                        const x = offset + j * squareSize;
                        const z = offset + (7-i) * squareSize;
                        pieceEl.setAttribute('position', `${x} 0.01 ${z}`);
                        boardGroup.appendChild(pieceEl);
                    });
                });
            }
            function handleGameClick(evt) {
                if ((gameMode === 'pva' && game.turn() !== playerColor) || game.game_over()) return;
                const clickedEl = evt.target.closest('.chess-piece, .clickable-square, .legal-move-marker');
                if (!clickedEl) { clearLegalMoves(); gameState = 'IDLE'; selectedPieceEntity = null; return; }
                if (gameState === 'IDLE') {
                    if (clickedEl.classList.contains('chess-piece')) {
                        const square = clickedEl.dataset.square;
                        const piece = game.get(square);
                        if (piece && piece.color === game.turn()) selectPiece(clickedEl);
                    }
                } else if (gameState === 'PIECE_SELECTED') {
                    const toSquare = clickedEl.dataset.square;
                    if (toSquare) {
                        const fromSquare = selectedPieceEntity.dataset.square;
                        const move = game.move({ from: fromSquare, to: toSquare, promotion: 'q' });
                        if (move) movePiece();
                        else {
                            const pieceOnTarget = game.get(toSquare);
                            const targetEntity = document.querySelector(`.chess-piece[data-square="${toSquare}"]`);
                            if (pieceOnTarget && targetEntity && pieceOnTarget.color === game.turn()) selectPiece(targetEntity);
                            else { clearLegalMoves(); gameState = 'IDLE'; selectedPieceEntity = null; }
                        }
                    } else { clearLegalMoves(); gameState = 'IDLE'; selectedPieceEntity = null; }
                }
            }
            function selectPiece(entity) {
                clearLegalMoves();
                selectedPieceEntity = entity;
                gameState = 'PIECE_SELECTED';
                const moves = game.moves({ square: entity.dataset.square, verbose: true });
                moves.forEach(move => {
                    const pos = squareToPosition(move.to);
                    const marker = document.createElement('a-cylinder');
                    marker.setAttribute('radius', '0.03'); marker.setAttribute('height', '0.005');
                    marker.setAttribute('material', 'color: #10B981; opacity: 0.6');
                    marker.setAttribute('position', `${pos.x} 0.002 ${pos.z}`);
                    marker.dataset.square = move.to;
                    marker.classList.add('legal-move-marker', 'clickable-square');
                    document.querySelector('#board-group').appendChild(marker);
                    legalMoveEntities.push(marker);
                });
            }
            function clearLegalMoves() {
                legalMoveEntities.forEach(e => e.parentNode && e.parentNode.removeChild(e));
                legalMoveEntities = [];
            }
            function movePiece() {
                clearLegalMoves(); 
                gameState = 'IDLE';
                selectedPieceEntity = null;
                renderBoardFromFen(document.querySelector('#board-container'));
                updateGameStatus();
                if (!game.game_over() && gameMode === 'pva' && game.turn() !== playerColor) {
                    setTimeout(makeAIMove, 500);
                }
            }
            function makeAIMove() {
                const moves = game.moves();
                if (moves.length > 0) {
                    game.move(moves[Math.floor(Math.random() * moves.length)]);
                    movePiece();
                }
            }
            function updateGameStatus() {
                let status = '';
                const moveColor = game.turn() === 'w' ? 'Blancas' : 'Negras';
                if (game.in_checkmate()) status = `¬°Jaque Mate! Ganan las ${moveColor === 'Blancas' ? 'Negras' : 'Blancas'}`; 
                else if (game.in_draw()) status = 'Empate';
                else { status = `Turno de las ${moveColor}`; if (game.in_check()) status += ' - ¬°Jaque!'; }
                document.getElementById('game-status').textContent = status;
            }
            function squareToPosition(square) {
                const boardSize = 0.6; const squareSize = boardSize / 8;
                const offset = -boardSize/2 + squareSize/2;
                const col = 'abcdefgh'.indexOf(square[0]);
                const row = 8 - parseInt(square[1], 10);
                return { x: offset + col * squareSize, z: offset + row * squareSize, y: 0.005 };
            }
        });
    </script>
</body>
</html>







